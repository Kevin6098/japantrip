<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Japan Trip 2026 - Budget Splitter</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Custom Styles -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="budget-splitter.css">
</head>
<body class="text-slate-700" id="main-body">

  <!-- Sakura Animation -->
  <div id="sakura-container" class="sakura-container"></div>

  <!-- Navigation -->
  <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-pink-200 no-print transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="homepage.html" class="flex items-center">
            <span class="text-pink-500 text-2xl mr-2">ğŸŒ¸</span>
            <span class="font-header text-xl font-bold text-slate-800 tracking-tight">
              <span class="lang-en">Japan Trip</span><span class="lang-zh">æ—¥æœ¬ä¹‹æ—…</span>
            </span>
          </a>
        </div>
        <!-- Desktop Nav -->
        <div class="hidden md:flex space-x-1 items-center">
          <a href="flights.html" class="nav-link">
            <span class="lang-en">Flights</span><span class="lang-zh">èˆªç­</span>
          </a>
          <a href="schedule.html" class="nav-link">
            <span class="lang-en">Itinerary</span><span class="lang-zh">è¡Œç¨‹</span>
          </a>
          <a href="budget.html" class="nav-link">
            <span class="lang-en">Budget</span><span class="lang-zh">é¢„ç®—</span>
          </a>
          <a href="packing.html" class="nav-link">
            <span class="lang-en">Packing</span><span class="lang-zh">æ¸…å•</span>
          </a>
          <a href="tourist-attraction.html" class="nav-link">
            <span class="lang-en">Attractions</span><span class="lang-zh">æ™¯ç‚¹</span>
          </a>
          <a href="hotel.html" class="nav-link">
            <span class="lang-en">Hotels</span><span class="lang-zh">ä½å®¿</span>
          </a>
          <a href="japan_trip_budget.html" class="nav-link active">
            <span class="lang-en">Split Expenses</span><span class="lang-zh">è´¹ç”¨åˆ†æ‘Š</span>
          </a>
          <!-- Language Switcher -->
          <button onclick="toggleLanguage()" class="ml-4 bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-full border border-slate-300 font-bold text-xs transition">
            ğŸŒ EN / ä¸­
          </button>
        </div>
        <!-- Mobile menu button -->
        <div class="flex items-center gap-2 md:hidden">
          <button onclick="toggleLanguage()" class="flex items-center justify-center w-10 h-10 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg border border-slate-300 text-sm transition-all duration-200 active:scale-95">
            ğŸŒ
          </button>
          <button id="hamburger-btn" onclick="toggleMobileMenu()" class="hamburger-button" aria-label="Toggle menu" aria-expanded="false">
            <div class="hamburger-icon">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </button>
        </div>
      </div>
    </div>
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="mobile-menu">
      <div class="mobile-menu-content space-y-1">
        <a href="flights.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-plane mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Flights</span><span class="lang-zh">èˆªç­</span>
        </a>
        <a href="schedule.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-calendar-days mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Itinerary</span><span class="lang-zh">è¡Œç¨‹</span>
        </a>
        <a href="budget.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-yen-sign mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Budget</span><span class="lang-zh">é¢„ç®—</span>
        </a>
        <a href="packing.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-suitcase mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Packing</span><span class="lang-zh">è¡Œææ¸…å•</span>
        </a>
        <a href="tourist-attraction.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-camera mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Attractions</span><span class="lang-zh">æ™¯ç‚¹</span>
        </a>
        <a href="hotel.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-hotel mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Hotels</span><span class="lang-zh">ä½å®¿</span>
        </a>
        <a href="japan_trip_budget.html" class="mobile-nav-link" onclick="closeMobileMenu()">
          <i class="fa-solid fa-calculator mr-3 text-pink-500 w-5"></i>
          <span class="lang-en">Split Expenses</span><span class="lang-zh">è´¹ç”¨åˆ†æ‘Š</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Back Button -->
  <a href="homepage.html" class="back-button no-print" aria-label="Back to Homepage">
    <i class="fa-solid fa-arrow-left"></i>
  </a>

  <!-- Header Section -->
  <div class="bg-gradient-to-br from-emerald-50 via-white to-teal-50 py-8 md:py-12 border-b border-emerald-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-4 mb-4">
        <div class="p-3 bg-emerald-100 rounded-xl shadow-inner">
          <i class="fa-solid fa-calculator text-emerald-600 text-2xl md:text-3xl"></i>
        </div>
        <div>
          <h1 class="font-header text-2xl md:text-3xl font-bold text-slate-800 mb-1">
            <span class="lang-en">Budget Splitter</span><span class="lang-zh">è´¹ç”¨åˆ†æ‘Šå™¨</span>
          </h1>
          <p class="text-sm md:text-base text-slate-600">
            <span class="lang-en">Offline tracker â€” auto split expenses by selected members + per-member totals.</span>
            <span class="lang-zh">ç¦»çº¿è¿½è¸ªå™¨ â€” è‡ªåŠ¨æŒ‰é€‰å®šæˆå‘˜åˆ†æ‘Šè´¹ç”¨ + æ¯äººæ€»è®¡ã€‚</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="budget-splitter-wrap py-8 md:py-12">
    <div class="budget-splitter-grid">
      <!-- Left Column: Input Form -->
      <div class="budget-card">
        <h2><span class="lang-en">1) Members</span><span class="lang-zh">1) æˆå‘˜</span></h2>

        <div class="budget-row" style="margin-bottom:10px;">
          <div>
            <label class="budget-label"><span class="lang-en">Add member name</span><span class="lang-zh">æ·»åŠ æˆå‘˜å§“å</span></label>
            <input id="memberName" class="budget-input" placeholder="e.g., Ang" />
          </div>
          <div style="display:flex;align-items:end;">
            <button id="addMemberBtn" class="budget-btn"><span class="lang-en">Add Member</span><span class="lang-zh">æ·»åŠ æˆå‘˜</span></button>
          </div>
        </div>

        <div id="memberChips" class="budget-chips"></div>
        <div class="budget-muted" style="margin-top:8px;">
          <span class="lang-en">Members are saved automatically.</span><span class="lang-zh">æˆå‘˜ä¼šè‡ªåŠ¨ä¿å­˜ã€‚</span>
        </div>

        <hr style="border:0;border-top:1px solid #eef0f6;margin:14px 0;"/>

        <h2><span class="lang-en">2) Add an expense</span><span class="lang-zh">2) æ·»åŠ è´¹ç”¨</span></h2>
        <div class="budget-row3">
          <div>
            <label class="budget-label"><span class="lang-en">Date</span><span class="lang-zh">æ—¥æœŸ</span></label>
            <input id="expDate" class="budget-input" type="date" />
          </div>
          <div>
            <label class="budget-label"><span class="lang-en">Category</span><span class="lang-zh">ç±»åˆ«</span></label>
            <select id="expCategory" class="budget-select">
              <option value="Meal">Meal</option>
              <option value="Transport">Transport</option>
              <option value="Tickets">Tickets</option>
              <option value="Shopping">Shopping</option>
              <option value="Hotel">Hotel</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="budget-label"><span class="lang-en">Currency</span><span class="lang-zh">è´§å¸</span></label>
            <select id="expCurrency" class="budget-select">
              <option value="JPY" selected>JPY</option>
              <option value="MYR">MYR</option>
              <option value="USD">USD</option>
              <option value="SGD">SGD</option>
            </select>
          </div>
        </div>

        <div class="budget-row" style="margin-top:10px;">
          <div>
            <label class="budget-label"><span class="lang-en">Description</span><span class="lang-zh">æè¿°</span></label>
            <input id="expDesc" class="budget-input" placeholder="e.g., Ichiran ramen" />
          </div>
          <div>
            <label class="budget-label"><span class="lang-en">Amount</span><span class="lang-zh">é‡‘é¢</span></label>
            <input id="expAmount" class="budget-input" type="number" min="0" step="0.01" placeholder="e.g., 4800" />
          </div>
        </div>

        <div class="budget-row" style="margin-top:10px;">
          <div>
            <label class="budget-label"><span class="lang-en">Paid by</span><span class="lang-zh">ä»˜æ¬¾äºº</span></label>
            <select id="expPaidBy" class="budget-select"></select>
          </div>
          <div>
            <label class="budget-label"><span class="lang-en">Split mode</span><span class="lang-zh">åˆ†æ‘Šæ¨¡å¼</span></label>
            <select id="splitMode" class="budget-select">
              <option value="equal" selected>Equal split</option>
              <option value="custom">Custom amounts</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label class="budget-label"><span class="lang-en">Split with (who should share this cost?)</span><span class="lang-zh">åˆ†æ‘Šå¯¹è±¡ï¼ˆè°åº”åˆ†æ‹…æ­¤è´¹ç”¨ï¼Ÿï¼‰</span></label>
          <div id="splitMembers" class="budget-splitBox"></div>
        </div>

        <div id="customSplitWrap" style="margin-top:10px; display:none;">
          <label class="budget-label"><span class="lang-en">Custom split (enter each member's share)</span><span class="lang-zh">è‡ªå®šä¹‰åˆ†æ‘Šï¼ˆè¾“å…¥æ¯ä¸ªæˆå‘˜çš„ä»½é¢ï¼‰</span></label>
          <div id="customSplitInputs" class="budget-splitBox"></div>
          <div id="customSplitHint" class="budget-muted" style="margin-top:6px;"></div>
        </div>

        <div class="budget-row" style="margin-top:12px;">
          <button id="addExpenseBtn" class="budget-btn"><span class="lang-en">Add Expense</span><span class="lang-zh">æ·»åŠ è´¹ç”¨</span></button>
          <button id="resetBtn" class="budget-btn budget-btn-danger"><span class="lang-en">Reset All Data</span><span class="lang-zh">é‡ç½®æ‰€æœ‰æ•°æ®</span></button>
        </div>

        <div id="formWarn" style="margin-top:10px; display:none;" class="budget-warn"></div>
      </div>

      <!-- Right Column: Summary & Expenses -->
      <div class="budget-card">
        <div class="budget-toolbar" style="justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div>
            <h2 style="margin:0;"><span class="lang-en">Summary</span><span class="lang-zh">æ‘˜è¦</span></h2>
            <div class="budget-muted">
              <span class="lang-en">Totals are per member (based on splits), not "paid by".</span>
              <span class="lang-zh">æ€»è®¡æŒ‰æˆå‘˜ï¼ˆåŸºäºåˆ†æ‘Šï¼‰ï¼Œè€Œé"ä»˜æ¬¾äºº"ã€‚</span>
            </div>
          </div>
          <div class="budget-toolbar">
            <button id="exportBtn" class="budget-btn budget-btn-ghost"><span class="lang-en">Export CSV</span><span class="lang-zh">å¯¼å‡ºCSV</span></button>
            <button id="clearExpensesBtn" class="budget-btn budget-btn-secondary"><span class="lang-en">Clear Expenses Only</span><span class="lang-zh">ä»…æ¸…é™¤è´¹ç”¨</span></button>
          </div>
        </div>

        <div id="totalsArea"></div>

        <hr style="border:0;border-top:1px solid #eef0f6;margin:14px 0;"/>

        <h2><span class="lang-en">Expenses</span><span class="lang-zh">è´¹ç”¨</span></h2>
        <div style="overflow:auto; border-radius: 12px; border: 1px solid #eef0f6;">
          <table id="expensesTable" class="budget-table">
            <thead>
              <tr>
                <th style="min-width:95px;"><span class="lang-en">Date</span><span class="lang-zh">æ—¥æœŸ</span></th>
                <th style="min-width:90px;"><span class="lang-en">Category</span><span class="lang-zh">ç±»åˆ«</span></th>
                <th><span class="lang-en">Description</span><span class="lang-zh">æè¿°</span></th>
                <th style="min-width:95px;"><span class="lang-en">Paid by</span><span class="lang-zh">ä»˜æ¬¾äºº</span></th>
                <th style="min-width:110px;" class="budget-right"><span class="lang-en">Amount</span><span class="lang-zh">é‡‘é¢</span></th>
                <th style="min-width:220px;"><span class="lang-en">Split details</span><span class="lang-zh">åˆ†æ‘Šè¯¦æƒ…</span></th>
                <th style="min-width:90px;"><span class="lang-en">Action</span><span class="lang-zh">æ“ä½œ</span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="budget-muted" style="margin-top:10px;">
          <span class="lang-en">Tip: If you want "who owes who" settlement later, tell me and I'll add it.</span>
          <span class="lang-zh">æç¤ºï¼šå¦‚æœæ‚¨æƒ³è¦"è°æ¬ è°"çš„ç»“ç®—åŠŸèƒ½ï¼Œå‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šæ·»åŠ å®ƒã€‚</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="script.js"></script>
  <script>
    // ===== Pre-filled members (your list) =====
    const DEFAULT_MEMBERS = [
      "Soon Zheng Dong",
      "Soon Cheng Wai",
      "Soon Xin Yi",
      "See Siew Pheng",
      "Ang Shin Nee",
      "See Siew Tin",
      "See Siew Kim",
      "See Eng Kim",
      "See Yi Joe",
      "Koay Jun Ming"
    ];

    // --------- Storage ----------
    const STORAGE_KEY = "jp_trip_budget_splitter_v1";

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { members: [], expenses: [] };
        const st = JSON.parse(raw);
        if (!st.members) st.members = [];
        if (!st.expenses) st.expenses = [];
        return st;
      } catch {
        return { members: [], expenses: [] };
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // --------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function formatMoney(amount, currency) {
      const n = Number(amount || 0);
      const fixed = (Math.round(n * 100) / 100).toFixed(2);
      return `${fixed} ${currency}`;
    }

    function todayISO() {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60 * 1000);
      return local.toISOString().slice(0, 10);
    }

    function uniqId() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function showWarn(msg) {
      const el = $("formWarn");
      el.textContent = msg;
      el.style.display = "block";
    }
    function hideWarn() {
      const el = $("formWarn");
      el.style.display = "none";
      el.textContent = "";
    }

    // --------- UI Rendering ----------
    function renderMembers() {
      const chips = $("memberChips");
      chips.innerHTML = "";
      state.members.forEach((m) => {
        const div = document.createElement("div");
        div.className = "budget-chip";
        div.innerHTML = `<span>${escapeHtml(m.name)}</span>`;
        const btn = document.createElement("button");
        btn.textContent = document.body.classList.contains('zh-mode') ? "åˆ é™¤" : "Remove";
        btn.onclick = () => {
          state.members = state.members.filter(x => x.id !== m.id);
          state.expenses = state.expenses.map(e => {
            delete e.splits[m.id];
            e.splitWith = (e.splitWith || []).filter(id => id !== m.id);
            if (e.paidBy === m.id) e.paidBy = state.members[0]?.id || "";
            return e;
          });
          saveState();
          renderAll();
        };
        div.appendChild(btn);
        chips.appendChild(div);
      });

      const paidBy = $("expPaidBy");
      paidBy.innerHTML = "";
      state.members.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.name;
        paidBy.appendChild(opt);
      });

      const splitWrap = $("splitMembers");
      splitWrap.innerHTML = "";
      state.members.forEach((m) => {
        const label = document.createElement("label");
        label.className = "budget-check";
        label.innerHTML = `<input type="checkbox" value="${m.id}" checked /> <span>${escapeHtml(m.name)}</span>`;
        splitWrap.appendChild(label);
      });

      renderCustomSplitInputs();

      if (!$("expDate").value) $("expDate").value = todayISO();

      if (state.members.length === 0) {
        showWarn(document.body.classList.contains('zh-mode') ? "è‡³å°‘æ·»åŠ 1ä¸ªæˆå‘˜æ‰èƒ½å¼€å§‹ã€‚" : "Add at least 1 member to start.");
      } else {
        hideWarn();
        if (!paidBy.value) paidBy.value = state.members[0].id;
      }
    }

    function renderCustomSplitInputs() {
      const wrap = $("customSplitInputs");
      wrap.innerHTML = "";
      state.members.forEach((m) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <label class="budget-label">${escapeHtml(m.name)}</label>
          <input type="number" min="0" step="0.01" class="budget-input" data-mid="${m.id}" placeholder="0" />
        `;
        wrap.appendChild(div);
      });
      $("customSplitHint").textContent = document.body.classList.contains('zh-mode') 
        ? "æç¤ºï¼šæ‚¨å¯ä»¥å–æ¶ˆé€‰ä¸­ä¸Šé¢çš„æˆå‘˜ã€‚åªè®¡ç®—é€‰ä¸­çš„æˆå‘˜ã€‚" 
        : "Tip: You can uncheck members above. Only checked members are counted.";
    }

    function renderTotals() {
      const area = $("totalsArea");
      if (state.members.length === 0) {
        area.innerHTML = `<div class="budget-warn">${document.body.classList.contains('zh-mode') ? "è¿˜æ²¡æœ‰æˆå‘˜ã€‚" : "No members yet."}</div>`;
        return;
      }

      const totals = {};
      const catTotals = {};
      for (const exp of state.expenses) {
        const cur = exp.currency || "JPY";
        if (!totals[cur]) totals[cur] = {};
        if (!catTotals[cur]) catTotals[cur] = {};
        if (!catTotals[cur][exp.category]) catTotals[cur][exp.category] = 0;

        catTotals[cur][exp.category] += Number(exp.amount || 0);

        for (const mid of Object.keys(exp.splits || {})) {
          const v = Number(exp.splits[mid] || 0);
          if (!totals[cur][mid]) totals[cur][mid] = 0;
          totals[cur][mid] += v;
        }
      }

      const blocks = Object.keys(totals).sort();
      if (blocks.length === 0) {
        area.innerHTML = `<div class="budget-warn">${document.body.classList.contains('zh-mode') ? "è¿˜æ²¡æœ‰è´¹ç”¨ã€‚åœ¨å·¦ä¾§æ·»åŠ æ‚¨çš„ç¬¬ä¸€ç¬”è´¹ç”¨ã€‚" : "No expenses yet. Add your first expense on the left."}</div>`;
        return;
      }

      area.innerHTML = blocks.map(cur => {
        const memberRows = state.members.map(m => {
          const v = totals[cur][m.id] || 0;
          return `<tr><td>${escapeHtml(m.name)}</td><td class="budget-right"><b>${formatMoney(v, cur)}</b></td></tr>`;
        }).join("");

        const categoryRows = Object.keys(catTotals[cur] || {}).sort().map(cat => {
          return `<tr><td>${escapeHtml(cat)}</td><td class="budget-right">${formatMoney(catTotals[cur][cat], cur)}</td></tr>`;
        }).join("");

        const grand = Object.values(catTotals[cur] || {}).reduce((a,b)=>a+b,0);

        return `
          <div class="budget-card" style="padding:12px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div><b>${cur}</b> <span class="budget-pill">${document.body.classList.contains('zh-mode') ? 'æ€»è®¡' : 'Totals'}</span></div>
              <div class="budget-small">${document.body.classList.contains('zh-mode') ? 'æ€»æ”¯å‡ºï¼š' : 'Total spent: '}<b>${formatMoney(grand, cur)}</b></div>
            </div>

            <div class="budget-row" style="margin-top:10px;">
              <div style="border:1px solid #eef0f6; border-radius:12px; overflow:hidden;">
                <table class="budget-table">
                  <thead><tr><th>${document.body.classList.contains('zh-mode') ? 'æˆå‘˜' : 'Member'}</th><th class="budget-right">${document.body.classList.contains('zh-mode') ? 'ä»–ä»¬çš„ä»½é¢' : 'Their share'}</th></tr></thead>
                  <tbody>${memberRows}</tbody>
                </table>
              </div>

              <div style="border:1px solid #eef0f6; border-radius:12px; overflow:hidden;">
                <table class="budget-table">
                  <thead><tr><th>${document.body.classList.contains('zh-mode') ? 'ç±»åˆ«' : 'Category'}</th><th class="budget-right">${document.body.classList.contains('zh-mode') ? 'æ€»è®¡' : 'Total'}</th></tr></thead>
                  <tbody>${categoryRows || `<tr><td colspan="2" class="budget-small">${document.body.classList.contains('zh-mode') ? 'è¿˜æ²¡æœ‰ç±»åˆ«' : 'No categories yet'}</td></tr>`}</tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderExpensesTable() {
      const tbody = $("expensesTable").querySelector("tbody");
      tbody.innerHTML = "";

      if (state.expenses.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7" class="budget-small" style="padding:14px;">${document.body.classList.contains('zh-mode') ? 'è¿˜æ²¡æœ‰è´¹ç”¨ã€‚' : 'No expenses yet.'}</td>`;
        tbody.appendChild(tr);
        return;
      }

      const exps = [...state.expenses].sort((a,b) => (b.date||"").localeCompare(a.date||""));

      for (const exp of exps) {
        const tr = document.createElement("tr");
        const paidByName = state.members.find(m => m.id === exp.paidBy)?.name || "-";

        const splitText = Object.entries(exp.splits || {})
          .filter(([,v]) => Number(v) > 0)
          .map(([mid, v]) => {
            const name = state.members.find(m => m.id === mid)?.name || mid;
            return `${name}: ${formatMoney(v, exp.currency)}`;
          })
          .join("<br/>") || `<span class='budget-small'>-</span>`;

        tr.innerHTML = `
          <td>${escapeHtml(exp.date || "")}</td>
          <td>${escapeHtml(exp.category || "")}</td>
          <td>${escapeHtml(exp.desc || "")}</td>
          <td>${escapeHtml(paidByName)}</td>
          <td class="budget-right"><b>${formatMoney(exp.amount, exp.currency)}</b></td>
          <td class="budget-small">${splitText}</td>
          <td><button class="budget-btn budget-btn-danger" style="padding:8px 10px; width:auto;" data-del="${exp.id}">${document.body.classList.contains('zh-mode') ? 'åˆ é™¤' : 'Delete'}</button></td>
        `;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-del");
          state.expenses = state.expenses.filter(e => e.id !== id);
          saveState();
          renderAll();
        };
      });
    }

    function renderAll() {
      renderMembers();
      renderTotals();
      renderExpensesTable();
      syncSplitModeUI();
    }

    // --------- Split logic ----------
    function getCheckedMemberIds() {
      return Array.from(document.querySelectorAll("#splitMembers input[type=checkbox]"))
        .filter(ch => ch.checked)
        .map(ch => ch.value);
    }

    function buildSplits(amount, currency) {
      const splitMode = $("splitMode").value;
      const checked = getCheckedMemberIds();

      if (checked.length === 0) return { ok: false, msg: document.body.classList.contains('zh-mode') ? "è‡³å°‘é€‰æ‹©1ä¸ªæˆå‘˜è¿›è¡Œåˆ†æ‘Šã€‚" : "Choose at least 1 member to split with." };

      const amt = Number(amount);
      if (!isFinite(amt) || amt <= 0) return { ok: false, msg: document.body.classList.contains('zh-mode') ? "è¾“å…¥æœ‰æ•ˆé‡‘é¢ > 0ã€‚" : "Enter a valid amount > 0." };

      const splits = {};
      if (splitMode === "equal") {
        const each = amt / checked.length;
        for (const mid of checked) splits[mid] = each;
        return { ok: true, splits };
      }

      let sum = 0;
      for (const mid of checked) {
        const input = document.querySelector(`#customSplitInputs input[data-mid="${mid}"]`);
        const v = Number(input?.value || 0);
        splits[mid] = v;
        sum += v;
      }

      const diff = Math.abs(sum - amt);
      if (diff > 0.01) {
        return { ok: false, msg: document.body.classList.contains('zh-mode') 
          ? `è‡ªå®šä¹‰åˆ†æ‘Šæ€»é¢å¿…é¡»ç­‰äºè´¹ç”¨é‡‘é¢ã€‚å½“å‰ï¼š${formatMoney(sum, currency)}ï¼ˆéœ€è¦ ${formatMoney(amt, currency)}ï¼‰ã€‚`
          : `Custom split total must equal the expense amount. Currently: ${formatMoney(sum, currency)} (needs ${formatMoney(amt, currency)}).` };
      }
      return { ok: true, splits };
    }

    function syncSplitModeUI() {
      const mode = $("splitMode").value;
      $("customSplitWrap").style.display = (mode === "custom") ? "block" : "none";
    }

    // --------- CSV Export ----------
    function exportCSV() {
      const rows = [];
      rows.push(["Date","Category","Currency","Description","Amount","PaidBy","SplitDetails"].join(","));

      for (const exp of state.expenses) {
        const paidByName = state.members.find(m => m.id === exp.paidBy)?.name || "";
        const splitDetails = Object.entries(exp.splits || {})
          .map(([mid,v]) => {
            const name = state.members.find(m => m.id === mid)?.name || mid;
            return `${name}:${Number(v).toFixed(2)}`;
          }).join(" | ");

        rows.push([
          csvCell(exp.date || ""),
          csvCell(exp.category || ""),
          csvCell(exp.currency || ""),
          csvCell(exp.desc || ""),
          csvCell(Number(exp.amount || 0).toFixed(2)),
          csvCell(paidByName),
          csvCell(splitDetails)
        ].join(","));
      }

      const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "japan_trip_budget.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function csvCell(s) {
      const t = String(s ?? "");
      const escaped = t.replace(/"/g, '""');
      return `"${escaped}"`;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // --------- Events ----------
    $("addMemberBtn").onclick = () => {
      const name = $("memberName").value.trim();
      if (!name) return showWarn(document.body.classList.contains('zh-mode') ? "æˆå‘˜å§“åä¸èƒ½ä¸ºç©ºã€‚" : "Member name cannot be empty.");
      hideWarn();
      state.members.push({ id: uniqId(), name });
      $("memberName").value = "";
      saveState();
      renderAll();
    };

    $("splitMode").onchange = syncSplitModeUI;
    $("addExpenseBtn").onclick = () => {
      hideWarn();
      if (state.members.length === 0) return showWarn(document.body.classList.contains('zh-mode') ? "è¯·å…ˆæ·»åŠ è‡³å°‘1ä¸ªæˆå‘˜ã€‚" : "Add at least 1 member first.");

      const date = $("expDate").value || todayISO();
      const category = $("expCategory").value;
      const currency = $("expCurrency").value;
      const desc = $("expDesc").value.trim();
      const amount = $("expAmount").value;

      const paidBy = $("expPaidBy").value;
      if (!paidBy) return showWarn(document.body.classList.contains('zh-mode') ? "é€‰æ‹©ä»˜æ¬¾äººã€‚" : "Select who paid.");

      const { ok, splits, msg } = buildSplits(amount, currency);
      if (!ok) return showWarn(msg);

      const splitWith = getCheckedMemberIds();

      state.expenses.push({
        id: uniqId(),
        date,
        category,
        currency,
        desc,
        amount: Number(amount),
        paidBy,
        splitWith,
        splits
      });

      $("expDesc").value = "";
      $("expAmount").value = "";
      document.querySelectorAll("#customSplitInputs input").forEach(i => i.value = "");

      saveState();
      renderAll();
    };

    $("clearExpensesBtn").onclick = () => {
      if (!confirm(document.body.classList.contains('zh-mode') ? "æ¸…é™¤æ‰€æœ‰è´¹ç”¨ï¼ˆä¿ç•™æˆå‘˜ï¼‰ï¼Ÿ" : "Clear all expenses (keep members)?")) return;
      state.expenses = [];
      saveState();
      renderAll();
    };

    $("resetBtn").onclick = () => {
      if (!confirm(document.body.classList.contains('zh-mode') ? "é‡ç½®æ‰€æœ‰å†…å®¹ï¼ˆæˆå‘˜ + è´¹ç”¨ï¼‰ï¼Ÿ" : "Reset EVERYTHING (members + expenses)?")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = { members: [], expenses: [] };
      bootstrapDefaultMembers(); // bring defaults back after reset
      saveState();
      renderAll();
    };

    $("exportBtn").onclick = exportCSV;

    // ===== Bootstrap defaults (only if no members yet) =====
    function bootstrapDefaultMembers() {
      if (state.members.length > 0) return;
      state.members = DEFAULT_MEMBERS.map(n => ({ id: uniqId(), name: n }));
    }

    // init
    $("expDate").value = $("expDate").value || todayISO();
    bootstrapDefaultMembers();
    saveState();
    renderAll();
  </script>
</body>
</html>
